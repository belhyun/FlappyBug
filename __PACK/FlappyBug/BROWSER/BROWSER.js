FlappyBug.GameView=CLASS({statics:function(cls){"use strict";cls.gameWidth=360;cls.gameHeight=480},preset:function(){"use strict";return VIEW},init:function(cls,inner,self){"use strict";var bgm=SOUND({mp3:FlappyBug.R_URI("bgm.mp3"),ogg:FlappyBug.R_URI("bgm.ogg"),isLoop:true}).play(),scoreStore=FlappyBug.STORE("score"),passPipeCount=0,isStarted,isGameOver,createPipeInterval,updateCanvasLoop,keydownEvent,resizeEvent,wrapper,countPanel,startPanel,endModal,surface,center,ground,bug,pipes=[],startGame,close;TITLE("FlappyBug :: Game");wrapper=DIV({style:{position:"absolute",left:0,top:0,width:"100%",height:"100%"},childs:[surface=USCREEN.SURFACE({style:{position:"absolute",left:0,top:0,backgroundColor:"#00C4D3"}}),startPanel=UUI.V_CENTER({wrapperStyle:{position:"absolute",left:0,top:0,width:"100%",height:"100%"},childs:[UUI.PANEL({wrapperStyle:{width:150,margin:"auto",backgroundColor:"#73BE31",border:"5px solid #666"},contentStyle:{padding:10},childs:[P({style:{fontSize:12},childs:[BROWSER_CONFIG.USCREEN===undefined||BROWSER_CONFIG.USCREEN.isLayerOnCanvas===true?"HTML5 Canvas Mode":"DOM Mode"]}),P({childs:["BEST SCORE: ",scoreStore.get("best")===undefined?0:scoreStore.get("best")]}),P({style:{fontSize:12},childs:["TOUCH or\nSPACE KEY/CLICK\nto START!"]})]})]}),countPanel=DIV({style:{position:"absolute",left:0,top:0,textAlign:"center",zIndex:999,width:"100%",fontSize:20,marginTop:10},childs:[0]})],on:{touchstart:function(e){if(isStarted!==true){isStarted=true;startGame()}bug.jump();e.stop()}}}).appendTo(BODY);ANIMATE({dom:startPanel.getDom(),keyframes:KEYFRAMES({from:{transform:"scaleY(0)"},to:{transform:"scaleY(100%)"}}),duration:.2,timingFunction:"ease-out"});surface.setSize({width:cls.gameWidth,height:cls.gameHeight});center=USCREEN.LAYER().appendTo(surface);ground=FlappyBug.Game.Ground().appendTo(center);bug=FlappyBug.Game.Bug(function(){var modal,buttonStyle;isGameOver=true;bgm.stop();ground.removeGroundLoop();clearInterval(createPipeInterval);EACH(pipes,function(pipe){pipe.removeMoveLoop()});if(scoreStore.get("best")===undefined||parseInt(scoreStore.get("best"),10)<passPipeCount){scoreStore.save({key:"best",value:passPipeCount})}endModal=UUI.MODAL({wrapperStyle:{width:200,margin:"auto",backgroundColor:"#73BE31",border:"5px solid #666"},contentStyle:{padding:10},isCannotClose:true,childs:[P({childs:["YOUR SCORE: ",passPipeCount]}),P({childs:["BEST SCORE: ",scoreStore.get("best")]}),UUI.BUTTON({style:buttonStyle={marginTop:10,padding:10,backgroundColor:"#fff",color:"#666",borderRadius:10},msg:"HOME",onTap:function(){FlappyBug.GO("")}}),UUI.BUTTON({style:buttonStyle,msg:"RESTART",onTap:function(){FlappyBug.GO("Restart")}}),P({style:{marginTop:10,fontSize:12},childs:["or SPACE KEY to RESTART."]}),Facebook.LikeButton({style:{marginTop:10},href:"http://flappybug.uppercase.io",layout:"button_count"})]});ANIMATE({dom:endModal.getDom(),keyframes:KEYFRAMES({from:{transform:"scaleY(0)"},to:{transform:"scaleY(100%)"}}),duration:.2,timingFunction:"ease-out"})}).appendTo(center);startGame=function(){ANIMATE({dom:startPanel.getDom(),keyframes:KEYFRAMES({from:{transform:"scaleY(100%)"},to:{transform:"scaleY(0)"}}),duration:.2,timingFunction:"ease-in"},function(){startPanel.remove()});createPipeInterval=setInterval(function(){pipes.push(FlappyBug.Game.Pipe({pipes:pipes,bug:bug},function(){passPipeCount+=1;countPanel.removeAllChilds();countPanel.append(passPipeCount)}).appendTo(center))},2e3)};keydownEvent=EVENT({name:"keydown"},function(e){if(e.getKeyCode()===32){if(isStarted!==true){isStarted=true;startGame()}bug.jump();if(isGameOver===true){FlappyBug.GO("Restart")}e.stop()}});resizeEvent=EVENT({name:"resize"},RAR(function(){var wrapperWidth=wrapper.getWidth(),wrapperHeight=wrapper.getHeight(),scale=wrapperWidth/cls.gameWidth<wrapperHeight/cls.gameHeight?wrapperWidth/cls.gameWidth:wrapperHeight/cls.gameHeight,size=surface.setScale(scale);surface.addStyle({left:(wrapperWidth-size.width)/2,top:(wrapperHeight-size.height)/2});countPanel.addStyle({top:(wrapperHeight-size.height)/2})}));updateCanvasLoop=LOOP(function(){center.updateCanvas()});self.close=close=function(params){TITLE(CONFIG.defaultTitle);wrapper.remove();if(endModal!==undefined){ANIMATE({dom:endModal.getDom(),keyframes:KEYFRAMES({from:{transform:"scaleY(100%)"},to:{transform:"scaleY(0)"}}),duration:.2,timingFunction:"ease-in"},function(){endModal.remove()})}updateCanvasLoop.remove();clearInterval(createPipeInterval);keydownEvent.remove();resizeEvent.remove();if(isGameOver!==true){bgm.stop()}}}});FlappyBug.HomeView=CLASS({preset:function(){"use strict";return VIEW},init:function(cls,inner,self){"use strict";var buttonStyle,modal,close;TITLE("FlappyBug :: Home");modal=UUI.MODAL({isCannotClose:true,wrapperStyle:{backgroundColor:"#73BE31",zIndex:999},contentStyle:{padding:20,paddingBottom:15,textAlign:"center"},childs:[H1({childs:[IMG({src:FlappyBug.R("logo.png")}),"\nbuilt with ",A({href:"http://uppercase.io",target:"_blank",childs:["UPPERCASE"]})]}),UUI.BUTTON({style:buttonStyle={marginTop:10,padding:10,backgroundColor:"#fff",color:"#666",borderRadius:10},msg:"CANVAS START",onTap:function(){BROWSER_CONFIG.USCREEN={isLayerOnCanvas:true};FlappyBug.GO("Game")}}),UUI.BUTTON({style:buttonStyle,msg:"DOM START",onTap:function(){BROWSER_CONFIG.USCREEN={isLayerOnCanvas:false};FlappyBug.GO("Game")}}),DIV({style:{marginTop:10},childs:[A({href:"https://github.com/BTNcafe/FlappyBug",target:"_blank",childs:["SOURCE CODE"]})]}),Facebook.LikeButton({style:{marginTop:10},href:"http://flappybug.uppercase.io",layout:"button_count"})]});ANIMATE({dom:modal.getDom(),keyframes:KEYFRAMES({from:{transform:"scaleY(0)"},to:{transform:"scaleY(100%)"}}),duration:.2,timingFunction:"ease-out"});self.close=close=function(params){TITLE(CONFIG.defaultTitle);ANIMATE({dom:modal.getDom(),keyframes:KEYFRAMES({from:{transform:"scaleY(100%)"},to:{transform:"scaleY(0)"}}),duration:.2,timingFunction:"ease-in"},function(){modal.remove()})}}});FlappyBug.MAIN=METHOD({run:function(m,params){"use strict";FlappyBug.MATCH_VIEW({uris:[""],target:FlappyBug.HomeView});FlappyBug.MATCH_VIEW({uris:["Game"],target:FlappyBug.GameView});FlappyBug.MATCH_VIEW({uris:["Restart"],target:CLASS({preset:function(){return VIEW},init:function(cls,inner,self){FlappyBug.GO("Game")}})})}});FlappyBug("Game").Bug=CLASS({statics:function(cls){"use strict";cls.halfCollisionWidth=30/2;cls.halfCollisionHeight=20/2},init:function(cls,inner,self,onDie){"use strict";var jumpSound=SOUND({mp3:FlappyBug.R_URI("jump.mp3"),ogg:FlappyBug.R_URI("jump.ogg")}),dieSound=SOUND({mp3:FlappyBug.R_URI("die.mp3"),ogg:FlappyBug.R_URI("die.ogg")}),waitingLoopCount=0,g=9.80665,gs,left=60,top=200,halfImgWidth,halfImgHeight,degree,isDead,frameCount=0,animationLoop,waitingLoop,gravityLoop,layer,appendTo,remove,die,jump,getPosition;layer=USCREEN.LAYER();EVENT({node:IMG({src:FlappyBug.R("bug.png")}),name:"load"},function(e,img){halfImgWidth=img.getWidth()/2/2;halfImgHeight=img.getHeight()/2;layer.setClipWidth(halfImgWidth*2);layer.setImg(img);layer.moveTo({left:left-halfImgWidth,top:top-halfImgHeight,zIndex:3})});animationLoop=LOOP(20,function(){layer.setClipLeft(frameCount*halfImgWidth*2);frameCount+=1;if(frameCount>=2){frameCount=0}});waitingLoop=LOOP(function(){waitingLoopCount+=.1;top+=Math.sin(waitingLoopCount)/2;layer.moveTo({top:top-halfImgHeight})});layer.addAfterRemoveProc(function(){if(animationLoop!==undefined){animationLoop.remove()}if(waitingLoop!==undefined){waitingLoop.remove()}if(gravityLoop!==undefined){gravityLoop.remove()}});self.appendTo=appendTo=function(parent){layer.appendTo(parent);return self};self.remove=remove=function(){layer.remove()};self.die=die=function(){isDead=true;dieSound.play();animationLoop.remove();animationLoop=undefined;onDie()};self.jump=jump=function(){if(isDead!==true){gs=-5;degree=-45;jumpSound.play();if(gravityLoop===undefined){waitingLoop.remove();waitingLoop=undefined;gravityLoop=LOOP(function(){if(top+gs<400-cls.halfCollisionHeight){top+=gs;gs+=g/60*1.5;degree+=2;if(degree>90){degree=90}}else{top=400-cls.halfCollisionHeight;if(isDead!==true){die()}}if(top<0){top=0}layer.rotate({centerLeft:19,centerTop:19,degree:degree});layer.moveTo({top:top-halfImgHeight})})}}};self.getPosition=getPosition=function(){return{left:left,top:top}}}});FlappyBug("Game").Ground=CLASS({init:function(cls,inner,self){"use strict";var groundLoop,layer,appendTo,remove,removeGroundLoop;layer=USCREEN.LAYER({zIndex:2});EVENT({node:IMG({src:FlappyBug.R("ground.png")}),name:"load"},function(e,img){var left;for(left=0;left<FlappyBug.GameView.gameWidth;left+=img.getWidth()){USCREEN.LAYER({img:img,left:left,top:400}).appendTo(layer)}USCREEN.LAYER({img:img,left:left,top:400}).appendTo(layer);left=0;groundLoop=LOOP(function(){left-=2;layer.moveTo({left:left});if(left<=-img.getWidth()){left=0}})});layer.addAfterRemoveProc(function(){if(groundLoop!==undefined){groundLoop.remove()}});self.appendTo=appendTo=function(parent){layer.appendTo(parent);return self};self.remove=remove=function(){layer.remove()};self.removeGroundLoop=removeGroundLoop=function(){if(groundLoop!==undefined){groundLoop.remove();groundLoop=undefined}}}});FlappyBug("Game").Pipe=CLASS({init:function(cls,inner,self,params,onPass){"use strict";var Bug=FlappyBug.Game.Bug,pipes=params.pipes,bug=params.bug,passSound=SOUND({mp3:FlappyBug.R_URI("pass.mp3"),ogg:FlappyBug.R_URI("pass.ogg")}),isPassed,left=FlappyBug.GameView.gameWidth+100,top=Math.random()*250+100,moveLoop,layer,upipe,dpipe,appendTo,remove,removeMoveLoop;layer=USCREEN.LAYER({left:left,top:top,zIndex:1});upipe=USCREEN.LAYER({img:IMG({src:FlappyBug.R("upipe.png")}),top:-470}).appendTo(layer);dpipe=USCREEN.LAYER({img:IMG({src:FlappyBug.R("dpipe.png")}),top:30}).appendTo(layer);moveLoop=LOOP(function(){var bugPosition=bug.getPosition(),bugLeft=bugPosition.left,bugTop=bugPosition.top;left-=2;layer.moveTo({left:left});if(bugLeft-Bug.halfCollisionWidth<left+40&&left<bugLeft+Bug.halfCollisionWidth&&bugTop-Bug.halfCollisionHeight<top-70&&top-470<bugTop+Bug.halfCollisionHeight){bug.die()}else if(bugLeft-Bug.halfCollisionWidth<left+40&&left<bugLeft+Bug.halfCollisionWidth&&bugTop-Bug.halfCollisionHeight<top+430&&top+30<bugTop+Bug.halfCollisionHeight){bug.die()}if(isPassed!==true&&bugLeft-Bug.halfCollisionWidth>=left&&left+40>=bugLeft+Bug.halfCollisionWidth){onPass();isPassed=true;passSound.play()}if(left<-100){remove()}});layer.addAfterRemoveProc(function(){if(moveLoop!==undefined){moveLoop.remove()}REMOVE({data:pipes,value:self})});self.appendTo=appendTo=function(parent){layer.appendTo(parent);return self};self.remove=remove=function(){layer.remove()};self.removeMoveLoop=removeMoveLoop=function(){if(moveLoop!==undefined){moveLoop.remove();moveLoop=undefined}}}});(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date;a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-40148318-12","uppercase.io");ga("send","pageview");